name: LLMOps PR Evaluator

on:
  pull_request:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read
  pull-requests: write # IZIN PENTING: Supaya bot boleh komen di PR

jobs:
  compare-performance:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      # --- STEP 1: TEST BASELINE (MAIN BRANCH) ---
      - name: Checkout Main Branch
        uses: actions/checkout@v4
        with:
          ref: main          # Ambil kodingan versi Main (Stabil)
          path: main-code    # Simpan di folder khusus

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: pip install boto3

      - name: Run Evaluation on MAIN (Baseline)
        env:
          AGENT_ID: ${{ secrets.AGENT_ID }}
          AWS_REGION: us-east-1
        run: |
          cd main-code
          python scripts/evaluate.py
          mv metrics.json ../baseline_metrics.json
          echo "‚úÖ Baseline evaluation done."

      # --- STEP 2: TEST CURRENT BRANCH (PR) ---
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          path: pr-code      # Ambil kodingan versi PR (Eksperimen)

      - name: Run Evaluation on PR (New Code)
        env:
          AGENT_ID: ${{ secrets.AGENT_ID }}
          AWS_REGION: us-east-1
        run: |
          cd pr-code
          python scripts/evaluate.py
          mv metrics.json ../current_metrics.json
          echo "‚úÖ Current PR evaluation done."

      # --- STEP 3: COMPARE & COMMENT ---
      - name: Post PR Comment Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
                const baseline = JSON.parse(fs.readFileSync('baseline_metrics.json', 'utf8'));
                const current = JSON.parse(fs.readFileSync('current_metrics.json', 'utf8'));

                // --- HELPERS ---
                const clean = (text) => {
                    if (!text) return "-";
                    // Ganti pipe jadi I, enter jadi spasi
                    return text.replace(/\|/g, "I").replace(/[\r\n]+/g, " ").trim();
                };
                
                const cleanTable = (text) => {
                    if (!text) return "-";
                    // Ganti pipe jadi I, enter jadi <br>
                    return text.replace(/\|/g, "I").replace(/[\r\n]+/g, "<br>").trim();
                };

                // --- 1. SCORECARD ---
                const diff = current.accuracy - baseline.accuracy;
                let icon = '‚ûñ';
                if (diff > 0) icon = 'üöÄ (Improved)';
                if (diff < 0) icon = '‚ö†Ô∏è (Degraded)';

                // --- 2. VALIDATION REPORT (ALL ROWS) ---
                const currResults = current.results;
                
                // Header Tabel
                let validationRows = "| Status | Input Snippet | Ground Truth | Prediction |\n| :---: | :--- | :--- | :--- |\n";
                
                currResults.forEach(item => {
                    // Logic Icon
                    const statusIcon = item.is_correct ? "‚úÖ" : "‚ùå";
                    
                    // Format Label: Kalau [SPAM] jadi SPAM (biar rapi)
                    const expected = clean(item.expected);
                    const predicted = clean(item.actual_category);
                    
                    // Warna teks Prediction: Tebal kalau salah
                    const predDisplay = item.is_correct ? predicted : `**${predicted}**`;
                    
                    const inputShort = clean(item.input).substring(0, 40) + "...";
                    
                    validationRows += `| ${statusIcon} | ${inputShort} | ${expected} | ${predDisplay} |\n`;
                });

                // --- 3. INFERENCE REPORT (ANALYSIS & REASONING) ---
                let inferenceRows = "";
                if (current.demo_results && current.demo_results.length > 0) {
                    inferenceRows = current.demo_results.map(item => {
                        const colInput = cleanTable(item.input);
                        const colLabel = `**${cleanTable(item.category)}**`;
                        const colReason = cleanTable(item.reason);
                        
                        let colReply = cleanTable(item.reply);
                        if (colReply === "NO_REPLY") colReply = "<em>(No Reply)</em>";

                        return `| ${colInput} | ${colLabel} | ${colReason} | ${colReply} |`;
                    }).join("\n");
                } else {
                    inferenceRows = "| - | - | - | - |";
                }

                // --- 4. RAKIT LAPORAN ---
                let body = `
                ### ü§ñ LLMOps Report: ${context.sha.substring(0, 7)}
                
                #### üìä Scorecard
                | Metric | Main Branch | This PR | Change |
                | :--- | :---: | :---: | :---: |
                | **Accuracy** | ${baseline.accuracy.toFixed(2)}% | ${current.accuracy.toFixed(2)}% | ${icon} |
                
                ---
                
                #### üìã Validation Results (Full Data)
                _Menampilkan hasil tes validasi. Jika **Prediction** beda dengan **Ground Truth**, status akan Merah (‚ùå)._
                
                ${validationRows}
                
                ---
                
                #### üß† AI Reasoning Analysis
                _Analisis AI terhadap data baru (Live Inference)._
                
                | Input | Label | AI Analysis (Reasoning) | Generated Reply |
                | :--- | :--- | :--- | :--- |
                ${inferenceRows}
                `;

                // Anti-Indentasi
                body = body.replace(/^ +/gm, '');

                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: body
                });

            } catch (error) {
                console.log("Error generating report:", error);
                core.setFailed("Failed to generate report.");
            }