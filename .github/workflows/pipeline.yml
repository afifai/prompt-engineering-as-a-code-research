# --- STEP 3: COMPARE & COMMENT ---
      - name: Post PR Comment Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // 1. Baca hasil JSON dari kedua run
            const baseline = JSON.parse(fs.readFileSync('baseline_metrics.json', 'utf8'));
            const current = JSON.parse(fs.readFileSync('current_metrics.json', 'utf8'));

            // 2. Hitung Diff Akurasi
            const diff = current.accuracy - baseline.accuracy;
            let icon = '‚ûñ';
            if (diff > 0) icon = 'üöÄ (Improved)';
            if (diff < 0) icon = '‚ö†Ô∏è (Degraded)';

            // 3. Analisis Perbandingan Per Item
            let comparisonRows = "";
            const baseResults = baseline.results;
            const currResults = current.results;
            
            // Asumsi urutan data sama karena sumber CSV sama
            let regressionCount = 0;
            let improvementCount = 0;

            for (let i = 0; i < baseResults.length; i++) {
                const base = baseResults[i];
                const curr = currResults[i];
                
                // Cek Perbedaan Nasib (Benar -> Salah ATAU Salah -> Benar)
                // Kita hanya tampilkan yang BERUBAH statusnya biar tabel gak kepanjangan
                if (base.is_correct !== curr.is_correct) {
                    let statusIcon = "";
                    if (base.is_correct && !curr.is_correct) {
                        statusIcon = "‚ùå REGRESSION"; // Dulu bener, sekarang salah
                        regressionCount++;
                    } else if (!base.is_correct && curr.is_correct) {
                        statusIcon = "‚úÖ FIXED"; // Dulu salah, sekarang bener
                        improvementCount++;
                    }
                    
                    // Tambahkan ke baris tabel
                    comparisonRows += `| **${statusIcon}** | ${base.input.substring(0, 40)}... | ${base.expected} | ${base.actual_raw.substring(0, 20)}... | ${curr.actual_raw.substring(0, 20)}... |\n`;
                }
            }

            // Kalau tidak ada perubahan spesifik
            if (comparisonRows === "") {
                comparisonRows = "| ‚ûñ | No behavior changes detected on sample data. | | | |";
            }

            // 4. Susun Pesan Komentar Markdown
            const body = `
            ### ü§ñ LLMOps Impact Report
            
            **Overall Performance:**
            | Metric | Main Branch (Baseline) | This PR (Current) | Change |
            |--------|------------------------|-------------------|--------|
            | **Accuracy** | ${baseline.accuracy.toFixed(2)}% | ${current.accuracy.toFixed(2)}% | ${icon} |
            
            **Detailed Impact Analysis:**
            - **New Fixes:** ${improvementCount}
            - **Regressions:** ${regressionCount}
            
            <details open>
            <summary>üîç <strong>See Inference Differences</strong></summary>
            
            | Status | Input Snippet | Expected | Main Output | PR Output |
            |--------|---------------|----------|-------------|-----------|
            ${comparisonRows}
            
            </details>
            `;

            // 5. Post ke Pull Request
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });