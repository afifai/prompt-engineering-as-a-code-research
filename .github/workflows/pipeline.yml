name: LLMOps PR Evaluator

on:
  pull_request:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read
  pull-requests: write # IZIN PENTING: Supaya bot boleh komen di PR

jobs:
  compare-performance:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      # --- STEP 1: TEST BASELINE (MAIN BRANCH) ---
      - name: Checkout Main Branch
        uses: actions/checkout@v4
        with:
          ref: main          # Ambil kodingan versi Main (Stabil)
          path: main-code    # Simpan di folder khusus

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: pip install boto3

      - name: Run Evaluation on MAIN (Baseline)
        env:
          AGENT_ID: ${{ secrets.AGENT_ID }}
          AWS_REGION: us-east-1
        run: |
          cd main-code
          python scripts/evaluate.py
          mv metrics.json ../baseline_metrics.json
          echo "‚úÖ Baseline evaluation done."

      # --- STEP 2: TEST CURRENT BRANCH (PR) ---
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          path: pr-code      # Ambil kodingan versi PR (Eksperimen)

      - name: Run Evaluation on PR (New Code)
        env:
          AGENT_ID: ${{ secrets.AGENT_ID }}
          AWS_REGION: us-east-1
        run: |
          cd pr-code
          python scripts/evaluate.py
          mv metrics.json ../current_metrics.json
          echo "‚úÖ Current PR evaluation done."

      # --- STEP 3: COMPARE & COMMENT ---
      - name: Post PR Comment Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
                // 1. Baca hasil JSON dari kedua run
                const baseline = JSON.parse(fs.readFileSync('baseline_metrics.json', 'utf8'));
                const current = JSON.parse(fs.readFileSync('current_metrics.json', 'utf8'));

                // 2. Hitung Diff Akurasi
                const diff = current.accuracy - baseline.accuracy;
                let icon = '‚ûñ';
                if (diff > 0) icon = 'üöÄ (Improved)';
                if (diff < 0) icon = '‚ö†Ô∏è (Degraded)';

                // 3. Analisis Perbandingan Per Item
                let comparisonRows = "";
                const baseResults = baseline.results;
                const currResults = current.results;
                
                let regressionCount = 0;
                let improvementCount = 0;

                // Loop untuk mencari perbedaan nasib (Fixed / Regression)
                // Asumsi: Urutan data sama karena menggunakan file validation.csv yang sama
                for (let i = 0; i < baseResults.length; i++) {
                    const base = baseResults[i];
                    const curr = currResults[i];
                    
                    // Kita hanya tampilkan row yang BERUBAH statusnya
                    if (base.is_correct !== curr.is_correct) {
                        let statusIcon = "";
                        if (base.is_correct && !curr.is_correct) {
                            statusIcon = "‚ùå REGRESSION"; // Dulu bener -> Sekarang salah
                            regressionCount++;
                        } else if (!base.is_correct && curr.is_correct) {
                            statusIcon = "‚úÖ FIXED"; // Dulu salah -> Sekarang bener
                            improvementCount++;
                        }
                        
                        // Format string agar tabel tidak berantakan (Truncate)
                        const inputShort = base.input.length > 30 ? base.input.substring(0, 30) + "..." : base.input;
                        const baseOutShort = base.actual_raw.replace(/\n/g, " ").substring(0, 20) + "...";
                        const currOutShort = curr.actual_raw.replace(/\n/g, " ").substring(0, 20) + "...";

                        comparisonRows += `| **${statusIcon}** | ${inputShort} | ${base.expected} | ${baseOutShort} | ${currOutShort} |\n`;
                    }
                }

                // Jika tidak ada perubahan perilaku sama sekali
                if (comparisonRows === "") {
                    comparisonRows = "| ‚ûñ | No behavior changes detected on sample data. | | | |";
                }

                // 4. Susun Pesan Komentar Markdown
                const body = `
                ### ü§ñ LLMOps Impact Report
                
                **Overall Performance:**
                | Metric | Main Branch (Baseline) | This PR (Current) | Change |
                |--------|------------------------|-------------------|--------|
                | **Accuracy** | ${baseline.accuracy.toFixed(2)}% | ${current.accuracy.toFixed(2)}% | ${icon} |
                | **Passed** | ${baseline.passed}/${baseline.total} | ${current.passed}/${current.total} | |
                
                **Detailed Impact Analysis:**
                - **New Fixes:** ${improvementCount}
                - **Regressions:** ${regressionCount}
                
                <details open>
                <summary>üîç <strong>See Inference Differences</strong></summary>
                
                | Status | Input Snippet | Expected | Main Output | PR Output |
                |--------|---------------|----------|-------------|-----------|
                ${comparisonRows}
                
                </details>
                `;

                // 5. Post ke Pull Request
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: body
                });

            } catch (error) {
                console.log("Error generating report:", error);
                core.setFailed("Failed to generate comparison report.");
            }